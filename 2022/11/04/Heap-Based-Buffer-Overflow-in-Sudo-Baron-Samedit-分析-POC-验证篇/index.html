<!DOCTYPE html>
<html lang=cn>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="从源码的角度去调试分析 CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit) 说实话我没有分析 cve 的习惯，我只是喜欢 RTFSC，其实是我太菜了。。。。。。 开始吧，我选用的是 sudo 1.9.0 版本，因为 没有为什么我随便选的（affects all legacy versions from 1.8.2 to">
<meta property="og:type" content="article">
<meta property="og:title" content="Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇">
<meta property="og:url" content="https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/index.html">
<meta property="og:site_name" content="scriptk1d">
<meta property="og:description" content="从源码的角度去调试分析 CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit) 说实话我没有分析 cve 的习惯，我只是喜欢 RTFSC，其实是我太菜了。。。。。。 开始吧，我选用的是 sudo 1.9.0 版本，因为 没有为什么我随便选的（affects all legacy versions from 1.8.2 to">
<meta property="og:locale">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012234064.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012235098.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012235217.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237571.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237269.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237924.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237327.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237737.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238922.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238266.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238580.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238572.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239879.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239116.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239125.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239082.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239033.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240513.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240100.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240102.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240590.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240165.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012241422.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012241644.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012241874.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242623.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242870.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242334.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242755.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242771.png">
<meta property="og:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012243535.png">
<meta property="article:published_time" content="2022-11-04T09:42:12.000Z">
<meta property="article:modified_time" content="2023-10-29T15:35:21.604Z">
<meta property="article:author" content="scriptk1d">
<meta property="article:tag" content="cve">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012234064.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/11/04/Linux-kernel-current-%E5%AE%8F/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&text=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&is_video=false&description=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇&body=Check out this article: https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&name=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&t=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#backtrace"><span class="toc-number">2.</span> <span class="toc-text">backtrace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#parse-args"><span class="toc-number">3.1.</span> <span class="toc-text">parse_args</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-number">3.2.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#policy-check"><span class="toc-number">3.3.</span> <span class="toc-text">policy_check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudoers-policy-check"><span class="toc-number">3.4.</span> <span class="toc-text">sudoers_policy_check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-cmnd"><span class="toc-number">3.5.</span> <span class="toc-text">set_cmnd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">引用</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">scriptk1d</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-11-04T09:42:12.000Z" class="dt-published" itemprop="datePublished">2022-11-04</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/cve/" rel="tag">cve</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>从源码的角度去调试分析 CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit)</p>
<p>说实话我没有分析 cve 的习惯，<del>我只是喜欢 RTFSC</del>，其实是我太菜了。。。。。。</p>
<p>开始吧，我选用的是 sudo 1.9.0 版本，因为 <del>没有为什么我随便选的</del>（affects all legacy versions from 1.8.2 to 1.8.31p2 and all stable versions from 1.9.0 to 1.9.5p1 in their default configuration.）</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>via: <a target="_blank" rel="noopener" href="https://codeload.github.com/sudo-project/sudo/zip/refs/tags/SUDO_1_9_0">https://codeload.github.com/sudo-project/sudo/zip/refs/tags/SUDO_1_9_0</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">╭─r00t at FakeLinux <span class="keyword">in</span> ~/code/SecurityResearch/CVE-2021-3156</span><br><span class="line">╰─○ <span class="built_in">cd</span> sudo-SUDO_1_9_0</span><br><span class="line"></span><br><span class="line">╭─r00t at FakeLinux <span class="keyword">in</span> ~/code/SecurityResearch/CVE-2021-3156/sudo-SUDO_1_9_0</span><br><span class="line">╰─○ <span class="built_in">mkdir</span> build</span><br><span class="line"></span><br><span class="line">╭─r00t at FakeLinux <span class="keyword">in</span> ~/code/SecurityResearch/CVE-2021-3156/sudo-SUDO_1_9_0</span><br><span class="line">╰─○ ../configure --prefix=/home/r00t/bin</span><br><span class="line"></span><br><span class="line">╭─r00t at FakeLinux <span class="keyword">in</span> ~/code/SecurityResearch/CVE-2021-3156/sudo-SUDO_1_9_0</span><br><span class="line">╰─○ make -j4</span><br><span class="line"></span><br><span class="line">╭─r00t at FakeLinux <span class="keyword">in</span> ~/code/SecurityResearch/CVE-2021-3156/sudo-SUDO_1_9_0</span><br><span class="line">╰─○ sudo make install</span><br></pre></td></tr></table></figure>

<p>自己看好 <code>--prefix= </code>，设定成自己要安装的目录，别到时候覆盖本机的</p>
<p>编译好之后放着备用</p>
<h2 id="backtrace"><a href="#backtrace" class="headerlink" title="backtrace"></a>backtrace</h2><p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012234064.png" alt="image-20210405025537690"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[#0] 0x55d829ab7ad0 → parse_args(argc=0x3, argv=0x55d82b875220, old_optind=0x7ffede10dd2c, nargc=0x7ffede10dd28, nargv=0x7ffede10dd30, settingsp=0x7ffede10dd58, env_addp=0x7ffede10dd38)</span><br><span class="line">[#1] 0x55d829aa2bfb → main(argc=0x4, argv=0x7ffede10dfc8, envp=0x7ffede10dff0)</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012235098.png" alt="image-20210403023947915"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#0  set_cmnd () at ../../../plugins/sudoers/sudoers.c:857</span><br><span class="line">#1  0x00007f2892e36cf4 in sudoers_policy_main (argc=argc@entry=0x3, argv=argv@entry=0x56435dfcb220, pwflag=pwflag@entry=0x0, env_add=env_add@entry=0x0, verbose=verbose@entry=0x0, closure=closure@entry=0x7ffddfd1dc40) at ../../../plugins/sudoers/sudoers.c:353</span><br><span class="line">#2  0x00007f2892e2fbb2 in sudoers_policy_check (argc=0x3, argv=0x56435dfcb220, env_add=0x0, command_infop=0x7ffddfd1dd00, argv_out=0x7ffddfd1dd08, user_env_out=0x7ffddfd1dd10, errstr=0x7ffddfd1dd28) at ../../../plugins/sudoers/policy.c:984</span><br><span class="line">#3  0x000056435c62de6a in policy_check (user_env_out=0x7ffddfd1dd10, argv_out=0x7ffddfd1dd08, command_info=0x7ffddfd1dd00, env_add=0x0, argv=0x56435dfcb220, argc=0x3) at ../../src/sudo.c:1161</span><br><span class="line">#4  main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;, envp=&lt;optimized out&gt;) at ../../src/sudo.c:272</span><br></pre></td></tr></table></figure>

<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="parse-args"><a href="#parse-args" class="headerlink" title="parse_args"></a>parse_args</h3><p>文末引用 [1] 给的 POC ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudoedit -s <span class="string">&#x27;\&#x27;</span> `perl -e <span class="string">&#x27;print &quot;A&quot; x 65536&#x27;</span>` </span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012235217.png" alt="image-20210404235959152"></p>
<p>程序在 crash 的时候提示 top chunk 的 size 有问题，可以断定就是发生了堆溢出，然后覆盖到了 top chunk 的 size</p>
<p>去看看 sudo 怎么处理参数的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gef➤  bt</span><br><span class="line">#0  parse_args (argc=0x4, argv=0x7ffede10dfc8, old_optind=0x7ffede10dd2c, nargc=0x7ffede10dd28, nargv=0x7ffede10dd30, settingsp=0x7ffede10dd58, env_addp=0x7ffede10dd38) at ../../src/parse_args.c:257</span><br><span class="line">#1  0x000055d829aa2bfb in main (argc=0x4, argv=0x7ffede10dfc8, envp=0x7ffede10dff0) at ../../src/sudo.c:218</span><br></pre></td></tr></table></figure>

<p>parse_args 函数是 sudo 处理命令行参数的地方</p>
<p>@argc – 命令行参数个数</p>
<p>@argv – 命令行参数</p>
<p>@nargc – parse 后的得到的 nargv 数组的成员个数</p>
<p>@nargv – parse 后的命令行参数</p>
<p>@settingsp – parse 命令行参数得到 sudo_settings</p>
<p>@env_addp –  parse 环境变量得到的环境变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Command line argument parsing.</span></span><br><span class="line"><span class="comment"> * Sets nargc and nargv which corresponds to the argc/argv we&#x27;ll use</span></span><br><span class="line"><span class="comment"> * for the command to be run (if we are running one).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 参数 argc argv 都是直接从 main 函数的 argc argv 传过来的</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">parse_args</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="type">int</span> *old_optind, <span class="type">int</span> *nargc, <span class="type">char</span> ***nargv,</span></span><br><span class="line"><span class="params">    <span class="keyword">struct</span> sudo_settings **settingsp, <span class="type">char</span> ***env_addp)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> mode = <span class="number">0</span>;        <span class="comment">/* what mode is sudo to be run in? */</span> <span class="comment">// sudo 的运行模式</span></span><br><span class="line">    <span class="type">int</span> flags = <span class="number">0</span>;        <span class="comment">/* mode flags */</span> <span class="comment">// sudo 的运行模式的标识</span></span><br><span class="line">    <span class="type">int</span> valid_flags = DEFAULT_VALID_FLAGS; <span class="comment">// 用来校验 flags 是否合法</span></span><br><span class="line">    <span class="type">int</span> ch, i;</span><br><span class="line">    <span class="type">char</span> *cp;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *progname; <span class="comment">// 运行的程序名，判别运行的是 sudo 还是 sudoedit</span></span><br><span class="line">    <span class="type">int</span> proglen;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pass progname to plugin so it can call initprogname() */</span></span><br><span class="line">    <span class="comment">// 获取运行的程序的名称，其实这个东西跟 busybox 是一样的，sudo 和 sudoedit 其实都是同一个二进制文件</span></span><br><span class="line">    <span class="comment">// sudoedit 是 sudo 的一个软链接而已，但是运行的时候 进程名 是 sudoedit ,可以依据这个来判定需要执行 sudo 还是 sudoedit 的功能，可以看看 initprogname 的实现，其实 getprogname 返回的是全局变量 progname，存的就是当前运行程序的名称，程序在 parse_args 之前程序通过 initprogname 初始化了，好了有点扯远了。。。</span></span><br><span class="line">    progname = getprogname(); </span><br><span class="line">    sudo_settings[ARG_PROGNAME].value = progname;</span><br></pre></td></tr></table></figure>

<p>sudo_settings 结构和用法上像是个 hashmap（其实还是有很大区别的），<del>存的是各种运行属性（不知道具体名字我自己编的 运行属性）</del>，这里设置的是 progname</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sudo_settings</span> <span class="title">sudo_settings</span>[] =</span> &#123;</span><br><span class="line">    ......</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ARG_PROGNAME 12</span></span><br><span class="line">    &#123; <span class="string">&quot;progname&quot;</span> &#125;,</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>执行完可以看到</p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237571.png" alt="image-20210405005310280"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* First, check to see if we were invoked as &quot;sudoedit&quot;. */</span></span><br><span class="line">proglen = <span class="built_in">strlen</span>(progname); <span class="comment">// 获取进程名的长度</span></span><br><span class="line"><span class="comment">// 因为 sudo 有一个软链接 sudoedit，只要进程名长度大于 4 并且最后 4 个字母是 edit 时</span></span><br><span class="line"><span class="comment">// 确定运行的是 sudoedit 而不是 sudo</span></span><br><span class="line"><span class="comment">// 碎碎念：其实这里的 (progname + proglen - 4, &quot;edit&quot;) 写的很妙，程序名无关，就算 sudoedit 改成 sedit 还是能完美运行</span></span><br><span class="line"><span class="keyword">if</span> (proglen &gt; <span class="number">4</span> &amp;&amp; <span class="built_in">strcmp</span>(progname + proglen - <span class="number">4</span>, <span class="string">&quot;edit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">progname = <span class="string">&quot;sudoedit&quot;</span>;</span><br><span class="line">mode = MODE_EDIT; <span class="comment">// 设置运行模式为 MODE_EDIT</span></span><br><span class="line">sudo_settings[ARG_SUDOEDIT].value = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* XXX - should fill in settings at the end to avoid dupes */</span></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Some trickiness is required to allow environment variables</span></span><br><span class="line"><span class="comment"> * to be interspersed with command line options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// 解析 -xxx 参数，我删掉了其他无关的 case，我们只用到了 -s</span></span><br><span class="line"><span class="keyword">if</span> ((ch = getopt_long(argc, argv, short_opts, long_opts, <span class="literal">NULL</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">           .......</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        sudo_settings[ARG_USER_SHELL].value = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">        SET(flags, MODE_SHELL); <span class="comment">// 加上 MODE_SHELL</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">            ......</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237269.png" alt="image-20210405013054041"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!got_end_of_args &amp;&amp; is_envar) &#123;</span><br><span class="line">        <span class="comment">/* Insert key=value pair, crank optind and resume getopt. */</span></span><br><span class="line">        env_insert(&amp;extra_env, argv[optind]);</span><br><span class="line">        optind++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* Not an option or an environment variable -- we&#x27;re done. */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    argc -= optind;</span><br><span class="line">    argv += optind;</span><br><span class="line">    *old_optind = optind;</span><br><span class="line">    <span class="comment">// 按照我们使用 POC 调试，现在 argv 指针指向的是 &#x27;/&#x27;, argc 是 2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// mode 是从在解析 -xxx 参数的时候设置的，如果没有加参数，那么 mode 就是 0，相当于是运行 sudo xxxx，就比如我们平时 sudo cat 这样</span></span><br><span class="line">    <span class="comment">// MODE_RUN 就是使用 sudo 运行一个命令</span></span><br><span class="line">    <span class="keyword">if</span> (!mode)</span><br><span class="line">        mode = MODE_RUN;        <span class="comment">/* running a command */</span></span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ENABLE_SUDO_PLUGIN_API</span></span><br><span class="line">    sudo_settings[ARG_PLUGIN_DIR].value = sudo_conf_plugin_dir_path();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237924.png" alt="image-20210405020126257"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * For sudoedit we need to rewrite argv</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 因为我们运行的是 sudoedit ，在上面检测 进程名 的时候设置了 MODE_EDIT</span></span><br><span class="line">    <span class="keyword">if</span> (mode == MODE_EDIT) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(HAVE_SETRESUID) || defined(HAVE_SETREUID) || defined(HAVE_SETEUID)</span></span><br><span class="line">    <span class="type">char</span> **av;</span><br><span class="line">    <span class="type">int</span> ac;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里 reallocarray 的用法，第一个参数是 NULL，其实相当于调用了 realloc(NULL, 4 * sizeof(char *))，（我这里只是简单形容，真正的 reallocarray 源码会使用编译器内建函数 __builtin_mul_overflow 去计算 4 * sizeof(char *)，同时检查溢出......）</span></span><br><span class="line">    <span class="comment">// 其实到 realloc 里面（记住，如果你要看源码的话对应的函数应该是 __libc_realloc）,里面会有一句检查第一个参数是不是 NULL，如果是 NULL 直接就是通过 __libc_malloc （就是我们所说的 malloc）去分配所需的内存，扯远了，感兴趣可以自己去看看源码（好像是我啰嗦了，这些应该都是这篇文章读者的常识吧，呜呜呜）</span></span><br><span class="line">    av = reallocarray(<span class="literal">NULL</span>, argc + <span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="type">char</span> *)); <span class="comment">// 其实相当分配了一个 char * 数组，懂我的意思吧</span></span><br><span class="line">    <span class="comment">// av 指向的这块内存对应的 chunk 大小应该为：0x30</span></span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237327.png" alt="image-20210405022235727"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (av == <span class="literal">NULL</span>)</span><br><span class="line">    sudo_fatalx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line"><span class="keyword">if</span> (!gc_add(GC_PTR, av))</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Must have the command in argv[0]. */</span></span><br><span class="line">av[<span class="number">0</span>] = <span class="string">&quot;sudoedit&quot;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012237737.png" alt="image-20210405022935286"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把我们的 &#x27;/&#x27; 和 一堆 A 的地址放入 av</span></span><br><span class="line"><span class="keyword">for</span> (ac = <span class="number">0</span>; argv[ac] != <span class="literal">NULL</span>; ac++) &#123;</span><br><span class="line">    av[ac + <span class="number">1</span>] = argv[ac];</span><br><span class="line">&#125;</span><br><span class="line">av[++ac] = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>应该不用我特别说明了吧，rbx 存的一直都是 reallocarray 返回的地址，相当于 av 变量，为啥 -0x10，这是 chunk header 的大小（x86-64），这样就能看到整个 chunk，可以看到的是，所有的参数的地址都拷贝进了 av，参数的个数是 ac，为啥要这样做？因为函数马上就要 ret 了，我们解析的好的参数必须要放在 heap 上，否则函数 ret 后，相当于白忙活</p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238922.png" alt="image-20210405023520055"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    argv = av;</span><br><span class="line">    argc = ac;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    sudo_fatalx(U_(<span class="string">&quot;sudoedit is not supported on this platform&quot;</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// c 语言不能有多个返回值，直接修改传入的指针</span></span><br><span class="line">    *settingsp = sudo_settings;</span><br><span class="line">    *env_addp = extra_env.envp;</span><br><span class="line">    *nargc = argc;</span><br><span class="line">    *nargv = argv; <span class="comment">// av 必须放在堆上</span></span><br><span class="line">    <span class="comment">// 返回 mode | flags</span></span><br><span class="line">    debug_return_int(mode | flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238266.png" alt="image-20210405030108500"></p>
<p>分析到这里 parse_args 分析完毕</p>
<p>回到 main 函数</p>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">sudo_mode = parse_args(argc, argv, &amp;submit_optind, &amp;nargc, &amp;nargv,</span><br><span class="line">   &amp;settings, &amp;env_add);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Load plugins. */</span></span><br><span class="line">   <span class="keyword">if</span> (!sudo_load_plugins(&amp;policy_plugin, &amp;io_plugins, &amp;audit_plugins,</span><br><span class="line">       &amp;approval_plugins))</span><br><span class="line">   sudo_fatalx(U_(<span class="string">&quot;fatal error, unable to load plugins&quot;</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Allocate event base so plugin can use it. */</span></span><br><span class="line">   <span class="keyword">if</span> ((sudo_event_base = sudo_ev_base_alloc()) == <span class="literal">NULL</span>)</span><br><span class="line">   sudo_fatalx(<span class="string">&quot;%s&quot;</span>, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Open policy and audit plugins. */</span></span><br><span class="line">   <span class="comment">/* XXX - audit policy_open errors */</span></span><br><span class="line">   audit_open(settings, user_info, submit_optind, argv, envp);</span><br><span class="line">   policy_open(settings, user_info, envp);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> (sudo_mode &amp; MODE_MASK) &#123;</span><br><span class="line">   <span class="keyword">case</span> MODE_EDIT:</span><br><span class="line">   <span class="keyword">case</span> MODE_RUN:</span><br><span class="line">       <span class="comment">// 跟进去</span></span><br><span class="line">       policy_check(nargc, nargv, env_add, &amp;command_info, &amp;argv_out,</span><br><span class="line">       &amp;user_env_out);</span><br></pre></td></tr></table></figure>

<p>这里是我手残了输错了命令，重新运行了之后 nargv 的那个堆块的地址发生变化了，不然跟上面的图中的 parse_args 里的 av 是一样的才是，我直接补图吧</p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238580.png" alt="image-20210405032309245"></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012238572.png" alt="image-20210405032448286"></p>
<h3 id="policy-check"><a href="#policy-check" class="headerlink" title="policy_check"></a>policy_check</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">policy_check</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">    <span class="type">char</span> *env_add[], <span class="type">char</span> **command_info[], <span class="type">char</span> **argv_out[],</span></span><br><span class="line"><span class="params">    <span class="type">char</span> **user_env_out[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *errstr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> ok;</span><br><span class="line"></span><br><span class="line">    ok = policy_plugin.u.policy-&gt;check_policy(argc, argv, env_add,</span><br><span class="line">    command_info, argv_out, user_env_out, &amp;errstr);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239879.png" alt="image-20210405033716355"></p>
<p>可以看到 rax 存的是一个 policy_plugin 结构体偏移 64 的地址，减 64 就能得到结构体的起始地址</p>
<p>在后面 call 的时候又加上了 0x20，相当于 policy_plugin 结构体偏移量 0x60，得到的是  policy_plugin.u.policy-&gt;check_policy 函数的地址，其实最终调用的是 sudoers_policy_check  函数，位于：plugins&#x2F;sudoers&#x2F;policy.c</p>
<h3 id="sudoers-policy-check"><a href="#sudoers-policy-check" class="headerlink" title="sudoers_policy_check"></a>sudoers_policy_check</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">sudoers_policy_check</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[], <span class="type">char</span> *env_add[],</span></span><br><span class="line"><span class="params">    <span class="type">char</span> **command_infop[], <span class="type">char</span> **argv_out[], <span class="type">char</span> **user_env_out[],</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> **errstr)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sudoers_exec_args</span> <span class="title">exec_args</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ISSET(sudo_mode, MODE_EDIT))</span><br><span class="line">    SET(sudo_mode, MODE_RUN);</span><br><span class="line"></span><br><span class="line">    exec_args.argv = argv_out;</span><br><span class="line">    exec_args.envp = user_env_out;</span><br><span class="line">    exec_args.info = command_infop;</span><br><span class="line"></span><br><span class="line">    ret = sudoers_policy_main(argc, argv, <span class="number">0</span>, env_add, <span class="literal">false</span>, &amp;exec_args);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239116.png" alt="image-20210405041104031"></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239125.png" alt="image-20210405041152116"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sudoers_policy_main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[], <span class="type">int</span> pwflag, <span class="type">char</span> *env_add[],</span></span><br><span class="line"><span class="params">    <span class="type">bool</span> verbose, <span class="type">void</span> *closure)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *iolog_path = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">mode_t</span> cmnd_umask = ACCESSPERMS;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sudo_nss</span> *<span class="title">nss</span>;</span></span><br><span class="line">    <span class="type">int</span> cmnd_status = <span class="number">-1</span>, oldlocale, validated;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Environment variables specified on the command line. */</span></span><br><span class="line">    <span class="keyword">if</span> (env_add != <span class="literal">NULL</span> &amp;&amp; env_add[<span class="number">0</span>] != <span class="literal">NULL</span>)</span><br><span class="line">    sudo_user.env_vars = env_add;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Make a local copy of argc/argv, with special handling</span></span><br><span class="line"><span class="comment">     * for pseudo-commands and the &#x27;-i&#x27; option.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">0</span>) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* Must leave an extra slot before NewArgv for bash&#x27;s --login */</span></span><br><span class="line">    NewArgc = argc;</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239082.png" alt="image-20210405041704748"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NewArgv = reallocarray(<span class="literal">NULL</span>, NewArgc + <span class="number">2</span>, <span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012239033.png" alt="image-20210405041918337"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (NewArgv == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line">&#125;</span><br><span class="line">sudoers_gc_add(GC_VECTOR, NewArgv);</span><br><span class="line">NewArgv++;    <span class="comment">/* reserve an extra slot for --login */</span></span><br><span class="line"><span class="comment">// 将我们传入的参数的地址拷贝到 NewArgv </span></span><br><span class="line"><span class="built_in">memcpy</span>(NewArgv, argv, argc * <span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">NewArgv[NewArgc] = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>看到了吗，这是拷贝完之后，但是你会发现，指针在 chunk 中的位置不一样，其实就是因为上面那一句 <code>NewArgv++;</code> 留出了 8 个字节</p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240513.png" alt="image-20210405043143588"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ISSET(sudo_mode, MODE_LOGIN_SHELL) &amp;&amp; runas_pw != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        NewArgv[<span class="number">0</span>] = strdup(runas_pw-&gt;pw_shell);</span><br><span class="line">        <span class="keyword">if</span> (NewArgv[<span class="number">0</span>] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">        sudoers_gc_add(GC_PTR, NewArgv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If given the -P option, set the &quot;preserve_groups&quot; flag. */</span></span><br><span class="line">    <span class="comment">// 没有 -P，不会进入这个判断</span></span><br><span class="line">    <span class="keyword">if</span> (ISSET(sudo_mode, MODE_PRESERVE_GROUPS))</span><br><span class="line">    def_preserve_groups = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Find command in path and apply per-command Defaults. */</span></span><br><span class="line">    cmnd_status = set_cmnd();</span><br><span class="line">    <span class="keyword">if</span> (cmnd_status == NOT_FOUND_ERROR)</span><br><span class="line">    <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="set-cmnd"><a href="#set-cmnd" class="headerlink" title="set_cmnd"></a>set_cmnd</h3><p>问题就出在这里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Fill in user_cmnd, user_args, user_base and user_stat variables</span></span><br><span class="line"><span class="comment"> * and apply any command-specific defaults entries.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">set_cmnd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sudo_nss</span> *<span class="title">nss</span>;</span></span><br><span class="line">    <span class="type">char</span> *path = user_path;</span><br><span class="line">    <span class="type">int</span> ret = FOUND;</span><br><span class="line">    debug_decl(set_cmnd, SUDOERS_DEBUG_PLUGIN);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate user_stat for find_path() and match functions. */</span></span><br><span class="line">    user_stat = <span class="built_in">calloc</span>(<span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> stat));</span><br><span class="line">    <span class="keyword">if</span> (user_stat == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">    debug_return_int(NOT_FOUND_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Default value for cmnd, overridden below. */</span></span><br><span class="line">    <span class="comment">// 这里 user_cmnd == NULL 成立</span></span><br><span class="line">    <span class="keyword">if</span> (user_cmnd == <span class="literal">NULL</span>)</span><br><span class="line">    user_cmnd = NewArgv[<span class="number">0</span>];</span><br></pre></td></tr></table></figure>

<p>user_cmnd 指向字符串： sudoedit</p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240100.png" alt="image-20210405044536937"></p>
<p>user_cmnd 其实是 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define user_cmnd        (sudo_user.cmnd)</span><br></pre></td></tr></table></figure>

<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240102.png" alt="image-20210405045115950"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (sudo_mode &amp; (MODE_RUN | MODE_EDIT | MODE_CHECK)) &#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line"><span class="comment">/* set user_args */</span></span><br><span class="line"><span class="comment">// 现在 NewArgc == 3，这三个参数分别是 sudoedit / AAAAAAAAAAAAAAA....</span></span><br><span class="line"><span class="keyword">if</span> (NewArgc &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">char</span> *to, *from, **av;</span><br><span class="line">    <span class="type">size_t</span> size, n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Alloc and build up user_args. */</span></span><br><span class="line">    <span class="comment">// 计算参数的长度，其实是计算 / AAAAAAAAAAAAAAA.... 加起来的长度，因为后面拷贝的是参数，不拷贝进程名</span></span><br><span class="line">    <span class="comment">// 因为 av = NewArgv + 1，是从 / 开始的</span></span><br><span class="line">    <span class="keyword">for</span> (size = <span class="number">0</span>, av = NewArgv + <span class="number">1</span>; *av; av++)</span><br><span class="line">    size += <span class="built_in">strlen</span>(*av) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里，malloc 分配的 内存 的大小等于 / AAAAAAAAAAAAAAA.... 加起来的长度（这样说其实不严谨，还需要考虑对齐的，不只是分配那么大）</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span> || (user_args = <span class="built_in">malloc</span>(size)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    sudo_warnx(U_(<span class="string">&quot;%s: %s&quot;</span>), __func__, U_(<span class="string">&quot;unable to allocate memory&quot;</span>));</span><br><span class="line">    debug_return_int(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里的话，我调试的时候随便输入的， <code>2219</code> 个 A，加上 <code>\</code> 一共 <code>0x8ac</code> 个字符，还有字符串终止符 ‘\x00’，就是 <code>0x8ae</code>，现在 <code>malloc(0x8ae)</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240590.png" alt="image-20210405050811496"></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012240165.png" alt="image-20210405051421273"></p>
<p>可以看到分配的 <code>chunk</code> 大小为 <code>0x8c0</code>（1 是 inuse 标志）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ISSET(sudo_mode, MODE_SHELL|MODE_LOGIN_SHELL)) &#123;</span><br><span class="line">       <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * When running a command via a shell, the sudo front-end</span></span><br><span class="line"><span class="comment">        * escapes potential meta chars.  We unescape non-spaces</span></span><br><span class="line"><span class="comment">        * for sudoers matching and logging purposes.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="comment">// 问题就出在这里，一开始 from 指向的是字符串 &quot;\\x00&quot;</span></span><br><span class="line">       <span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">           <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">           <span class="comment">// 这个条件肯定为真，因为 from[0] == &#x27;\\&#x27; 并且 from[1] == &#x27;\x00&#x27;，isspace 判断的是 from[1] 是不是为 &#x27;\x20&#x27;，（这就是 POC 中 \ 的用处）</span></span><br><span class="line">           <span class="comment">// 可能是写代码的人当时蒙圈了，因为我们的参数在内存中是这样的： 0x414141414141005c，\ 和 AAAAAA... 是 &#x27;\x00&#x27; 分隔的</span></span><br><span class="line">           <span class="comment">// 他可能把 &#x27;\x00&#x27; 当成了空格 &#x27;\x20&#x27;，导致 !isspace((unsigned char)from[1] 然后 from++ </span></span><br><span class="line">           <span class="comment">// 看下面的第二张图，from++ 的汇编其实是 add r15,0x2</span></span><br><span class="line">           <span class="comment">// 导致 r15 存的地址是 0x00007ffd3083ae66，这个地址存的是 AAAAAA....</span></span><br><span class="line">           <span class="comment">// 导致，第一次 for 的时候其实就已经把 &#x27;\x00&#x27; 和 AAAAA..... 复制到 user_args 来了</span></span><br><span class="line">           <span class="comment">// 而会进行两次 for 循环，导致复制了 &#x27;\x00&#x27; (因为 from 指向 \ 时，from++; 了才 *to++ = *from++;) 和 两次 AAAAA..... 直接破坏了 heap 上的其他 chunk，在再次使用 malloc 的时候可能就因为 heap 上的 chunk 被破坏而 crash</span></span><br><span class="line">           <span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="type">unsigned</span> <span class="type">char</span>)from[<span class="number">1</span>]))</span><br><span class="line">               from++;</span><br><span class="line">           *to++ = *from++;</span><br><span class="line">           &#125;</span><br><span class="line">           *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       *--to = <span class="string">&#x27;\0&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>第一轮 <code>for</code> 第一轮 <code>while</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012241422.png" alt="image-20210405052403060"></p>
<p><code>from[0] == &#39;\\&#39; &amp;&amp; !isspace((unsigned char)from[1])</code> 条件为真，可以看出 <code>r15</code> 就是 <code>from</code> 指针，移动 <code>from</code> 指向 <code>AAAAAAA.....</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012241644.png" alt="image-20210405052701093"></p>
<p>第一次 <code>while</code> 结束</p>
<p>因为 <code>A</code> 太多了，我直接在第二次 <code>while</code> 结束下断点，然后 <code>c</code></p>
<p>第二次 <code>while</code> 结束</p>
<p>可以看到，复制上来了 <code>&#39;\x00&#39;</code> 和那些 <code>A</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012241874.png" alt="image-20210405054304582"></p>
<p>第一次 <code>while</code> 已经准备填满了 分配 的内存（差不多填满，差 <code>12</code> 字节），<code>0x557b8d3f4ea0</code> 是 <code>user_args</code> 对应的 <code>chunk</code> 的地址，加上 <code>0x8c0</code> （chunk 的大小，0x8c1 的 1 是相邻上一个 chunk 的 inuse 标识位，不能参与运算（自己补堆的知识））就能得到相邻的 <code>chunk</code> 的地址 <code>0x557b8d3f5760</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242623.png" alt="image-20210405054530410"></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242870.png" alt="image-20210405054720768"></p>
<p>我们继续，第二轮 <code>for</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242334.png" alt="image-20210405054944075"></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242755.png" alt="image-20210405055446837"></p>
<p>可以看到，<code>0x557b8d3f5760</code> 的那个 <code>chunk</code> 被覆盖了，可能在后面使用到这个 <code>chunk</code> 的时候就直接出错，只要填充够多，直接就覆盖到 <code>top chunk</code></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012242771.png" alt="image-20210405055719062"></p>
<p><img src="https://scriptk1d-images.oss-cn-hongkong.aliyuncs.com/202306012243535.png" alt="image-20210405060815845"></p>
<p>这就是完整的分析</p>
<p>后面再另外写怎么去利用这个漏洞提权。。。。</p>
<p><del>敬请期待 《 Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 –  利用篇》，算了，说这种屁话，估计都没人看</del></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>[1] <a target="_blank" rel="noopener" href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit#:~:text=%20If%20Sudo%20is%20executed%20to%20run%20a,at%20the%20beginning%20of%20Sudo%E2%80%99s%20main...%20More%20">CVE-2021-3156: Heap-Based Buffer Overflow in Sudo (Baron Samedit)</a></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#backtrace"><span class="toc-number">2.</span> <span class="toc-text">backtrace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#parse-args"><span class="toc-number">3.1.</span> <span class="toc-text">parse_args</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-number">3.2.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#policy-check"><span class="toc-number">3.3.</span> <span class="toc-text">policy_check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudoers-policy-check"><span class="toc-number">3.4.</span> <span class="toc-text">sudoers_policy_check</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-cmnd"><span class="toc-number">3.5.</span> <span class="toc-text">set_cmnd</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">引用</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&text=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&is_video=false&description=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇&body=Check out this article: https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&title=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&name=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://syscall.fun/2022/11/04/Heap-Based-Buffer-Overflow-in-Sudo-Baron-Samedit-%E5%88%86%E6%9E%90-POC-%E9%AA%8C%E8%AF%81%E7%AF%87/&t=Heap-Based Buffer Overflow in Sudo (Baron Samedit) 分析 -- POC 验证篇"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    scriptk1d
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
